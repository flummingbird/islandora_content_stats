<?php

/**
 * Implements hook_menu().
 */
function islandora_content_stats_menu() {
    $items = array();
    $items['admin/islandora/tools/content_stats'] = array(
        'title' => 'Content Statistics',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('islandora_content_stats_admin_form', 1),
        'access arguments' => array('administer site configuration'),
        'file' => 'includes/admin.form.inc',
    );
//    $items['data'] = array(
//        'title' => 'Content Statistics',
//        'page callback' => 'drupal_get_form',
//        'page arguments' => array('islandora_content_stats_form'),
//        'access arguments' => array('administer site configuration'),
//        'access callback' => TRUE,
//        'file' => 'includes/data.form.inc',
//    );
        $items['data'] = array(
        'title' => 'Content Statistics',
        'page callback' => 'islandora_content_stats_data_page',
        'access callback' => TRUE,
    );

    $items['data/download'] = array(//data
        'title' => t('Download Content Stats to CSV'),
        'page callback' => 'islandora_content_stats_csv_download',
        'access callback' => TRUE,
    );
    return $items;
}

function islandora_content_stats_data_page() {
    return theme('islandora_content_stats_data_tpl');
    
}

function islandora_content_stats_theme() {
    module_load_include('inc','islandora_content_stats','includes/language');
    module_load_include('inc','islandora_content_stats','includes/utilities');
    return array(
        'islandora_content_stats_data_tpl' => array(
            'template' => 'theme/data',
            'variables' => array( 'global_totals' => global_totals(), 'lang-desc' => lang('data_description'),
            ),
        ),
    );
}

function islandora_content_stats_preprocess_data(&$variables) {
    $variables['attributes'] ='eeey';
}

function data_process(&$variables){
    
}


/**
 * Download function
 * applies filters to queries and returns as csv file
 */
function islandora_content_stats_csv_download() {
    module_load_include('inc', 'islandora_content_stats', '/includes/utilities');
    $query = 'SELECT * FROM {islandora_content_stats}';
    $filters = array();
    foreach ($_GET as $key => $filter) {
        if ($filter != 'data/download') {
            $filters[$key] = $filter;
        }
    }
    //if requesting historic data
    if (isset($filters['all'])) {
        if ($filters['all'] == 1) {
            array_pop($filters);
            foreach ($filters as $key => $filter) {
                if (($key == 'inst') || ($key == 'cmodel') || ($key == 'coll')) {
                    if (strpos($query, 'WHERE') === FALSE) {
                        if ($filter != '') {
                            $query .= ' WHERE ' . $key . ' = \'' . $filter . '\'';
                        }
                    } else {
                        if ($filter != '') {
                            $query .= ' AND ' . $key . ' = \'' . $filter . '\'';
                        }
                    }
                }
            }
        }
        //when requesting latest data
        else {
            $max_time = '';
            $q_time = db_query('select MAX(timestamp) from {islandora_content_stats}');
            $max_time = $q_time->fetchField();
            $query .= ' WHERE timestamp = \'' . $max_time . '\'';
            array_pop($filters);
            foreach ($filters as $key => $filter) {
                if ($filter != '') {
                    $query .= ' AND ' . $key . ' = \'' . $filter . '\'';
                }
            }
        }
    }
    $results = db_query($query) or die('Sql error : ' . mysql_error());
    drupal_add_http_header('Content-type', 'text/csv; utf-8');
    $attach_str = 'attachment; filename=islandora_content_stats.csv';
    drupal_add_http_header('Content-Disposition', $attach_str);
    $fh = fopen('php://output', 'w');
    fputcsv($fh, array('ID', 'Institution', 'Collection', 'Cmodel', 'Count', 'Timestamp', 'URL'));
    foreach ($results as $result) {
        $not_fobj = $result->cmodel != 'fedora-system:FedoraObject-3.0';
        $not_cmobj = $result->cmodel != 'fedora-system:ContentModel-3.0';
        $not_rootcoll = $result->coll != 'islandora:root';
        if (($not_fobj) && ($not_cmobj) && ($not_rootcoll)) {
            $mapped_results = array(
                $result->id,
                map_institution($result->inst),
                map_collection($result->coll),
                map_cmodels($result->cmodel),
                $result->count,
                strftime('%d:%m:%Y:%r', $result->timestamp),
                map_collection($result->coll, 'csv')
            );
            fputcsv($fh, $mapped_results);
        }
    }
}

/**
 * Implements hook_cron().
 * must stay in .module file
 */
function islandora_content_stats_cron() {
    module_load_include('inc', 'islandora_content_stats', 'includes/queries');
    $time = time();
    $is_off_hours = is_off_hours($time);
    $days = 86400 * variable_get('islandora_content_stats_interval');
    $last_run = db_query('select max(timestamp) from {islandora_content_stats}');
    $last_run_time = $last_run->fetchField();
    $elapsed = $time - $last_run_time;
    if ($elapsed > $days && $is_off_hours) {
        islandora_content_stats_run_queries();
    }
}

function is_off_hours($time) {
    $check = strftime('%H', $time);
    $start = variable_get('islandora_content_stats_off_start', 20);
    $end = variable_get('islandora_content_stats_off_end', 23);
    if ($start > $end) {
        $range1 = range($start, 23);
        $range2 = range(0, $end);
        $range = array_merge($range1, $range2);
    } else {
        $range = range($start, $end);
    }
    if (in_array($check, $range)) {
        return TRUE;
    }
}

/**
 * Implements hook_block_info().
 * Displays cmodel count on content region
 * at islandora:root it shows totals sitewide
 * at a given collection it shows totals for that collection
 */
function islandora_content_stats_block_info() {
    $blocks = array();
    $blocks['mini'] = array(
        'info' => t('Content Stats Mini'),
        'status' => 0, //change to 1 to enable block.
        'region' => 'content',
        'visibility' => BLOCK_VISIBILITY_NOTLISTED,
        'pages' => '',
    );
    return $blocks;
}

/**
 * Implements hook_block_view().
 * Logic for which totals to display in block.
 */
function islandora_content_stats_block_view($delta = '') {
    module_load_include('inc', 'islandora_content_stats', 'includes/block.form');
    $blocks = array();
    module_load_include('php', 'islandora_namespace_homepage', 'includes/namespaces');
    $frontpage = drupal_is_front_page();
    $instpage = '';
    $ns_prefix = update_namespace_prefixes_cache();
    foreach ($ns_prefix as $prefix) {
        if (request_uri() == '/' . $prefix) {
            $instpage = TRUE;
        }
    }
    $collpage = strpos(request_uri(), 'collection');
    if ($frontpage || $instpage || $collpage) {
        $blocks['subject'] = t('Content Models');
        $blocks['content'] = drupal_get_form('islandora_content_stats_mini_form');
    }
    return $blocks;
}