<?php
require_once dirname(__FILE__) . '/includes/queries.inc';
require_once dirname(__FILE__) . '/includes/reports.form.inc';
require_once dirname(__FILE__) . '/includes/reports-page.form.inc';

/**
 * Implements hook_menu().
 */
function islandora_content_stats_menu() {
  $items = array();
  $items['admin/islandora/tools/content_stats'] = array(
    'title' => 'Content Statistics Admin',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_admin_form',1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );
  $items['admin/reports/content_stats'] = array(
    'title' => 'Content Statistics Report Last Run',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_table_form', 1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/reports.form.inc',
  );
  $items['admin/reports/content_stats/all'] = array(
    'title' => 'Content Statistics Report All Queries',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_content_stats_table_all_form', 1),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/reports-all.form.inc',
  );
  return $items;
}


function islandora_content_stats_post_collection_stats(){
  if(strpos(current_path(),'collection')){
    $str =current_path();
    $coll = str_replace('islandora/object/','',$str);
    return islandora_content_stats_page_cmodels($coll);
  }
}


function check_path(){
  $one_of_these = update_namespace_prefixes_cache();
      foreach($one_of_these as $ns_prefix){
      if(preg_match('/'.$ns_prefix.'/', str_replace('/','',request_uri()))){
        return true;
      }
    }
}

function islandora_content_stats_post_institution_stats(){
  if(!preg_match("/([\/]\w+[\/]\w+)/", request_uri())){
    if(check_path()){
      return islandora_content_stats_page_cmodels(str_replace('/','',request_uri()));
    }
  }
}

function islandora_root_page_stats(){
  return islandora_root_stats_queries();
}

// attempt to add classes to <tr> or <thead>
// function islandora_content_stats_form_alter(&$form,&$form_state,$form_id){
//   if( $form_id == 'islandora_content_stats_table_page_form'){
//     //$form['table']['#header']['#attributes']['class'][] = 'header_rows';
//     dpm($form);
//   }
//}

/**
* Implements hook_block_info().
*/
function islandora_content_stats_block_info() {
  $blocks = array();
    $blocks['content_stats'] = array(
      'info' => t('Content Stats'),
      'cache' => DRUPAL_CACHE_PER_USER
    );
    $blocks['content_stats_page'] = array(
      'info' => t('Content Stats Page Content Models'),
      'status' => 1,
      'region' => 'content',
      'visibility' => BLOCK_VISIBILITY_NOTLISTED,
      'pages' => 'islandora/
admin/*',
    );
  return $blocks;
}

// function islandora_content_stats_block_info_alter(&$blocks,$theme,$code_blocks){
//   if($theme == variable_get('theme_default', '0')){
//     if(isset($blocks['islandora_content_stats']['content_stats_page'])){
//       $blocks['islandora_content_stats']['content_stats_page']['region'] ='Content';
//     }
//   }
// }



function islandora_content_stats_block_view($delta = ''){
$blocks = array();
  switch ($delta) {
    case 'content_stats':
      $blocks['subject'] = t('Content Stats Block');
      $blocks['content'] = drupal_get_form('islandora_content_stats_table_form');
      break;
    case 'content_stats_page':
        $blocks['subject'] = t('Content Stats Page Content Models');
        $blocks['content'] = drupal_get_form('islandora_content_stats_table_page_form');
        break;
  }
  return $blocks;
}
