<?php

/**
 * Implements hook_menu().
 */
function islandora_content_stats_menu() {
    $items = array();
    $items['admin/islandora/tools/content_stats'] = array(
        'title' => 'Content Statistics',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('islandora_content_stats_admin_form', 1),
        'access arguments' => array('administer site configuration'),
        'file' => 'includes/admin.form.inc',
    );
        $items['data'] = array(
        'title' => 'Content Statistics',
        'page callback' => 'islandora_content_stats_data',
        'page arguments' => array('islandora_content_stats_form'),
        'file' => 'includes/data.form.inc',
        'access callback' => TRUE,
    );
    return $items;
}

function islandora_content_stats_data() {
    return theme('islandora_content_stats_data_tpl');

}


function islandora_content_stats_theme() {
    module_load_include('inc','islandora_content_stats','includes/language');
    module_load_include('inc','islandora_content_stats','includes/utilities');
    module_load_include('inc','islandora_content_stats','includes/queries');
    module_load_include('inc','islandora_content_stats','includes/data.form');
    $params =  drupal_get_query_parameters();
    return array(
        'islandora_content_stats_data_tpl' => array(
            'template' => 'theme/data',
            'render element' => 'form',
            'variables' => array(
                'global_totals' => global_totals(),
                'inst_totals' => inst_totals(),
                'lang' => array(
                  'pageHeader_title' => lang('pageHeader'),
                  'pageHeader_desc' => lang('pageHeader_description'),
                  'globalHeader' => lang('globalHeader'),
                  'globalHeader_desc' => lang('globalHeader_description'),
                  'instHeader' => lang('instHeader'),
                  'instHeader_desc' => lang('instHeader_description'),
                  'lang_total_title' => lang('totals_item_#title'),
                  //filters and dl go into form, not tpl.
                  //'filtersGrouping' => lang('filtersGrouping'),
                  //'filterCmodel_desc' => lang('filterCmodel_desc'),
                  'tableDesc' => lang('tableDesc'),
                  'tableTitle' => lang('tableTitle'),
                  'tableEmpty' => lang('tableEmpty'),
                  //'lang_dl_title' => lang('download_#title'),
                  //'lang_dl_submit' => lang('download_#submit'),
                ),
                'last_run' => gmdate("M d Y H:i:s", latest_run()),
                'params' => $params,
            ),
        ),
    );
}

function template_preprocess_islandora_content_stats_data_tpl(&$variables) {
  module_load_include('inc','islandora_content_stats','includes/utilities');
  module_load_include('inc','islandora_content_stats','includes/data.form');
  $gets = drupal_get_query_parameters();
  if(isset($gets['sortby'])){

  if($gets['sortby'] == 'inst' && $gets['order'] == 'asc'){
    $iorder = 'desc';
  }
  else{$iorder = 'asc';}
  if($gets['sortby'] == 'cmodel' && $gets['order'] == 'asc'){
    $torder = 'desc';
  }
  else{$torder='asc';}
  if($gets['sortby'] == 'count' && $gets['order'] == 'asc'){
    $corder = 'desc';
  }
  else{$corder='asc';}
}
else{
  $iorder = 'asc';
  $torder = 'asc';
  $corder = 'asc';
}
  $inst_arr = array('sortby' => 'inst', 'order' => $iorder);
  $cmodel_arr = array('sortby' => 'cmodel', 'order' => $iorder);
  $count_arr = array('sortby' => 'count', 'order' => $iorder);
  if(isset($gets['inst']) && isset($gets['cmodel'])){
    $inst_arr = array('sortby' => 'inst', 'order' => $iorder,'cmodel' => $gets['cmodel'],'inst' => $gets['inst']);
    $cmodel_arr = array('sortby' => 'cmodel', 'order' => $torder,'cmodel' => $gets['cmodel'],'inst' => $gets['inst']);
    $count_arr = array('sortby' => 'count', 'order' => $corder,'cmodel' => $gets['cmodel'],'inst' => $gets['inst']);
  }
  if(isset($gets['cmodel']) && !isset($gets['inst'])){
    $inst_arr = array('sortby' => 'inst', 'order' => $iorder,'cmodel' => $gets['cmodel']);
    $cmodel_arr = array('sortby' => 'cmodel', 'order' => $torder,'cmodel' => $gets['cmodel']);
    $count_arr =  array('sortby' => 'count', 'order' => $corder,'cmodel' => $gets['cmodel']);
  }
  if(isset($gets['inst']) && !isset($gets['cmodel'])){
    $inst_arr = array('sortby' => 'inst', 'order' => $iorder,'inst' => $gets['inst']);
    $cmodel_arr = array('sortby' => 'cmodel', 'order' => $torder,'inst' => $gets['inst']);
    $count_arr = array('sortby' => 'count', 'order' => $corder,'inst' => $gets['inst']);
  }

  $variables['gets'] = $gets;
  $variables['latest'] = latest_counts_for_table($gets);
  $variables['insturl'] = url('data',array('query' => $inst_arr));
  $variables['typeurl'] = url('data',array('query' => $cmodel_arr));
  $variables['counturl'] = url('data',array('query' => $count_arr));

    return $variables;
}

function template_process_islandora_content_stats_data_tpl() {
  module_load_include('inc','islandora_content_stats','includes/data.form');
  $gets = drupal_get_query_parameters();

  if(isset($gets['op'])){
    if($gets['op']== 'Download History as CSV'){
      islandora_content_stats_csv_download();
    }
  }
}

/**
 * Implements hook_cron().
 * must stay in .module file
 */
function islandora_content_stats_cron() {
    module_load_include('inc', 'islandora_content_stats', 'includes/queries');
    $time = time();
    $is_off_hours = is_off_hours($time);
    $days = 86400 * variable_get('islandora_content_stats_interval');
    $last_run = db_query('select max(timestamp) from {islandora_content_stats}');
    $last_run_time = $last_run->fetchField();
    $elapsed = $time - $last_run_time;
    if ($elapsed > $days && $is_off_hours) {
        islandora_content_stats_run_queries();
    }
}

function is_off_hours($time) {
    $check = strftime('%H', $time);
    $start = variable_get('islandora_content_stats_off_start', 20);
    $end = variable_get('islandora_content_stats_off_end', 23);
    if ($start > $end) {
        $range1 = range($start, 23);
        $range2 = range(0, $end);
        $range = array_merge($range1, $range2);
    } else {
        $range = range($start, $end);
    }
    if (in_array($check, $range)) {
        return TRUE;
    }
}
